# -------------------------------------------------------------------
# Kubernetes Deployment — MLOps Iris Classifier
# -------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlops-weather-prediction
spec:
  # Number of pod replicas to run for high availability
  replicas: 2

  # Match pods using this label selector
  selector:
    matchLabels:
      app: mlops-weather-prediction

  # Template describing the pod specification
  template:
    metadata:
      labels:
        app: mlops-weather-prediction
    spec:
      containers:
        - name: mlops-weather-prediction

          # Image hosted on Google Artifact Registry
          image: us-central1-docker.pkg.dev/sacred-garden-474511-b9/mlops-weather-prediction/mlops-weather-prediction:latest

          # Always pull the latest image version during deployment
          imagePullPolicy: Always

          # Expose the Flask application port
          ports:
            - containerPort: 5000

          # Define minimum resource requests per pod
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"

---
# -------------------------------------------------------------------
# Kubernetes Service — External Access via LoadBalancer
# -------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: mlops-service
spec:
  # Route traffic to pods matching this label
  selector:
    app: mlops-weather-prediction

  # Map external port 80 to the container’s internal port 5000
  ports:
    - protocol: TCP
      port: 80
      targetPort: 5000

  # Create a public-facing LoadBalancer for external access
  type: LoadBalancer